// Sample book content for each book
const bookContent = {
    1: {
        chapters: [
            {
                id: 1,
                title: "Chapter 1: The Beginning",
                content: `
                    <h1>Chapter 1: The Beginning</h1>
                    <p>Emma stood at the edge of the bustling market in Kampala, her heart filled with anticipation. The morning sun cast golden rays across the city, illuminating the vibrant fabrics and fresh produce that lined the streets. She had waited her entire life for this moment ‚Äì the journey that would change everything.</p>
                    
                    <p>The letter in her pocket felt heavy with promise. It was an invitation, a chance to discover her roots, to understand where she truly came from. For years, she had wondered about her heritage, about the stories her grandmother used to tell before she passed away. Now, those stories were calling her home.</p>
                    
                    <p>"Miss Emma?" A voice broke through her thoughts. She turned to see an elderly man with kind eyes and a weathered face. "I am Moses. Your grandmother sent me many years ago with a message. I have been waiting for you."</p>
                    
                    <p>Emma's breath caught in her throat. "You knew my grandmother?"</p>
                    
                    <p>"I did more than know her," Moses said with a smile. "I was entrusted with her greatest secret. And now, it is time for you to know the truth about your family's legacy."</p>
                    
                    <p>As they walked through the crowded streets, Moses began to tell her a story that would unravel everything she thought she knew about herself. The journey home was not just about returning to a place ‚Äì it was about discovering who she truly was.</p>
                `
            },
            {
                id: 2,
                title: "Chapter 2: Unveiling the Past",
                content: `
                    <h1>Chapter 2: Unveiling the Past</h1>
                    <p>The old house stood on the outskirts of town, hidden by overgrown vegetation and years of neglect. Yet as Emma approached it with Moses, she felt an inexplicable connection to the place. It was as if the walls themselves were whispering secrets of the past.</p>
                    
                    <p>"This was your grandmother's childhood home," Moses explained, pushing open the creaking gate. "She left it to you, along with everything inside. But more importantly, she left you the truth."</p>
                    
                    <p>Inside, dust motes danced in shafts of sunlight that pierced through broken shutters. The furniture was covered in white sheets, like ghosts of memories long forgotten. Moses led her to a heavy wooden chest in the corner of what must have been the living room.</p>
                    
                    <p>"Open it," he urged gently.</p>
                    
                    <p>With trembling hands, Emma lifted the lid. Inside were photographs, letters, and journals dating back decades. But what caught her attention was a small leather-bound book at the bottom. Its cover was embossed with a symbol she had seen before ‚Äì in her dreams.</p>
                    
                    <p>"That symbol," Moses said, noticing her recognition, "represents your family's lineage. You come from a long line of storytellers, Emma. Your grandmother was one of the greatest. And now, it is your turn to carry on the tradition."</p>
                    
                    <p>As Emma began to read the journal entries, she discovered a world she never knew existed ‚Äì a world of magic, mystery, and profound wisdom passed down through generations. Her journey home was only just beginning.</p>
                `
            },
            {
                id: 3,
                title: "Chapter 3: The Legacy",
                content: `
                    <h1>Chapter 3: The Legacy</h1>
                    <p>Days turned into weeks as Emma immersed herself in her grandmother's writings. Each page revealed new layers of her family's history, tales of courage, love, and sacrifice that spanned generations. She learned that her ancestors were not just storytellers ‚Äì they were keepers of ancient wisdom, guardians of cultural heritage.</p>
                    
                    <p>The journal spoke of a responsibility that came with this knowledge. It wasn't enough to simply know the stories; one had to live them, to embody the values they represented. Emma realized that her grandmother had been preparing her for this moment all along, through the bedtime stories and the lessons woven into everyday life.</p>
                    
                    <p>Moses visited her daily, helping her understand the deeper meanings behind the tales. "Your grandmother believed that stories have the power to heal, to unite, to transform," he told her one afternoon as they sat in the restored garden. "She saw that same gift in you, even when you were just a child."</p>
                    
                    <p>Emma thought about her life back in the city, the corporate job she had left behind, the emptiness she had felt despite her success. Now, surrounded by her grandmother's legacy, she understood what had been missing. Purpose. Connection. A sense of belonging to something greater than herself.</p>
                    
                    <p>"What do I do now?" she asked Moses.</p>
                    
                    <p>He smiled, the same knowing smile her grandmother used to have. "You do what you were born to do, Emma. You tell your story. And in doing so, you honor all those who came before you and inspire all those who will come after."</p>
                    
                    <p>As the sun set over the horizon, painting the sky in brilliant shades of orange and purple, Emma made her decision. She would stay. She would learn. And she would become the storyteller her grandmother always knew she could be. The journey home had led her not just to a place, but to her true self.</p>
                `
            }
        ]
    },
    2: {
        chapters: [
            {
                id: 1,
                title: "Chapter 1: The Mindset Revolution",
                content: `
                    <h1>Chapter 1: The Mindset Revolution</h1>
                    <p>Success is not an accident. It is not a stroke of luck or a gift reserved for the chosen few. Success is a mindset ‚Äì a way of thinking, acting, and believing that shapes your reality. In my years of working with entrepreneurs and leaders across Uganda and East Africa, I have discovered that the difference between those who succeed and those who struggle often comes down to one thing: their mindset.</p>
                    
                    <p>Your mindset is the lens through which you view the world. It determines how you interpret challenges, how you respond to setbacks, and how you pursue opportunities. A fixed mindset sees obstacles as insurmountable barriers, while a growth mindset sees them as stepping stones to greatness.</p>
                    
                    <h2>The Power of Belief</h2>
                    <p>Everything begins with belief. Before you can achieve anything significant, you must first believe it is possible. This is not about positive thinking or wishful hoping ‚Äì it is about cultivating a deep, unshakeable conviction in your ability to create the life you desire.</p>
                    
                    <p>I remember meeting a young entrepreneur named Sarah who wanted to start a tech company in Kampala. Everyone told her it was impossible, that the market wasn't ready, that she didn't have the resources. But Sarah had something more powerful than resources ‚Äì she had belief. She believed in her vision, in her ability to learn, and in her capacity to overcome obstacles.</p>
                    
                    <p>Today, Sarah's company employs over 100 people and serves clients across Africa. The difference? She cultivated a success mindset from day one. She saw challenges as opportunities to grow, failures as lessons to learn from, and setbacks as temporary obstacles to overcome.</p>
                    
                    <h2>Transforming Your Mental Framework</h2>
                    <p>Developing a success mindset requires intentional effort. It means challenging your limiting beliefs, expanding your comfort zone, and consistently taking action toward your goals. In the following chapters, we will explore practical strategies for transforming your mindset and unleashing your full potential.</p>
                `
            },
            {
                id: 2,
                title: "Chapter 2: Overcoming Fear",
                content: `
                    <h1>Chapter 2: Overcoming Fear</h1>
                    <p>Fear is the greatest obstacle to success. It keeps you stuck in your comfort zone, prevents you from taking risks, and whispers lies about your inadequacy. But here's the truth: courage is not the absence of fear ‚Äì it is action in the face of fear.</p>
                    
                    <p>Every successful person I know has faced fear. The difference is that they didn't let fear stop them. They felt the fear and moved forward anyway. They understood that on the other side of fear lies growth, opportunity, and transformation.</p>
                    
                    <h2>Understanding Your Fears</h2>
                    <p>The first step in overcoming fear is understanding it. What are you really afraid of? Failure? Rejection? Looking foolish? Financial loss? When you identify the specific fear, you can address it directly rather than letting it control you from the shadows.</p>
                    
                    <p>Take John, a businessman who was terrified of public speaking. This fear held him back from growing his business, as he couldn't pitch to investors or speak at industry events. Instead of avoiding his fear, John confronted it. He joined a speaking club, practiced regularly, and gradually built his confidence. Today, he is a sought-after speaker and his business has grown exponentially.</p>
                    
                    <h2>The Fear-Success Paradox</h2>
                    <p>Here's an interesting paradox: the things you fear most are often the things that will lead to your greatest breakthroughs. That uncomfortable conversation, that risky investment, that bold career move ‚Äì these are often the catalysts for transformation. When you run toward your fears instead of away from them, you discover strengths you never knew you had.</p>
                `
            }
        ]
    },
    // Add more book content here for other books...
    // For brevity, I'll create a generic template for remaining books
};

// Generic content generator for books without specific content
function generateGenericContent(bookId, bookTitle, bookAuthor) {
    return {
        chapters: [
            {
                id: 1,
                title: "Chapter 1: Introduction",
                content: `
                    <h1>Chapter 1: Introduction</h1>
                    <p>Welcome to "${bookTitle}" by ${bookAuthor}. This is an engaging story that will take you on an unforgettable journey.</p>
                    
                    <p>In this chapter, we begin our exploration of themes that will resonate throughout the book. Every great story has a beginning, and this is ours.</p>
                    
                    <p>As you turn each page, you'll discover characters that feel real, situations that challenge your thinking, and messages that stay with you long after you finish reading.</p>
                    
                    <p>This book is more than just words on pages ‚Äì it's an experience, a journey, and an invitation to see the world through a different lens.</p>
                `
            },
            {
                id: 2,
                title: "Chapter 2: The Journey Begins",
                content: `
                    <h1>Chapter 2: The Journey Begins</h1>
                    <p>Every journey has its challenges, its moments of doubt, and its unexpected turns. In this chapter, we dive deeper into the heart of our story.</p>
                    
                    <p>The path ahead is filled with both obstacles and opportunities. Our characters must navigate complex situations, make difficult choices, and discover truths about themselves they never knew existed.</p>
                    
                    <p>As you read, pay attention to the subtle themes emerging. Notice how each character's actions ripple through the narrative, creating consequences that shape the story's direction.</p>
                    
                    <p>This is where the real adventure begins. Hold on tight ‚Äì you're in for an incredible ride.</p>
                `
            },
            {
                id: 3,
                title: "Chapter 3: Transformation",
                content: `
                    <h1>Chapter 3: Transformation</h1>
                    <p>Change is inevitable, but transformation is a choice. In this chapter, we witness the profound shifts that occur when characters embrace growth.</p>
                    
                    <p>The lessons learned in previous chapters now begin to crystallize. Patterns emerge, connections form, and understanding deepens. This is the chapter where everything comes together.</p>
                    
                    <p>As our story progresses, themes of resilience, courage, and hope take center stage. These aren't just abstract concepts ‚Äì they're lived experiences that transform both the characters and, hopefully, you as the reader.</p>
                    
                    <p>What started as a simple tale has evolved into something much more meaningful. This is the power of storytelling ‚Äì it has the ability to change us, to inspire us, and to remind us of what's truly important in life.</p>
                    
                    <p>Thank you for joining us on this journey. May the insights you've gained serve you well in your own life's adventure.</p>
                `
            }
        ]
    };
}

// Check if user has access to a book
function hasAccess(bookId) {
    const purchases = JSON.parse(localStorage.getItem('lydistoriesPurchases') || '[]');
    return purchases.some(purchase => purchase.bookId == bookId);
}

// Check if book is in preview mode
function isPreviewMode(bookId) {
    return !hasAccess(bookId);
}

// Sync purchases from Firebase to localStorage
async function syncPurchasesFromFirebase() {
    try {
        // Get user identifier (email, phone, or device ID)
        const userId = getUserIdentifier();
        
        if (!userId) return;
        
        // Import firebase service dynamically
        const { default: firebaseService } = await import('./firebase-service.js');
        
        // Get purchases from Firebase
        const result = await firebaseService.getUserPurchases(userId);
        
        if (result.success && result.purchases.length > 0) {
            // Merge with local purchases
            const localPurchases = JSON.parse(localStorage.getItem('lydistoriesPurchases') || '[]');
            const allPurchases = [...localPurchases];
            
            // Add Firebase purchases that aren't already local
            result.purchases.forEach(fbPurchase => {
                const exists = allPurchases.some(p => 
                    p.bookId == fbPurchase.bookId && p.userId === userId
                );
                if (!exists) {
                    allPurchases.push({
                        bookId: fbPurchase.bookId,
                        bookTitle: fbPurchase.bookTitle,
                        amount: fbPurchase.amount,
                        provider: fbPurchase.paymentMethod,
                        userId: userId,
                        timestamp: fbPurchase.purchasedAt?.toDate?.()?.toISOString() || new Date().toISOString()
                    });
                }
            });
            
            // Save merged purchases
            localStorage.setItem('lydistoriesPurchases', JSON.stringify(allPurchases));
        }
    } catch (error) {
        console.log('Firebase sync not available:', error);
    }
}

// Get user identifier from localStorage or generate one
function getUserIdentifier() {
    let userId = localStorage.getItem('lydistoriesUserId');
    
    if (!userId) {
        // Generate a unique user ID
        userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('lydistoriesUserId', userId);
    }
    
    return userId;
}

// Get book content
function getBookContent(bookId) {
    // First check localStorage for admin-created content
    const bookContent = JSON.parse(localStorage.getItem('lydistoriesBookContent') || '{}');
    
    if (bookContent[bookId]) {
        return bookContent[bookId];
    }
    
    // Fall back to default content
    if (!bookContent[bookId]) {
        // Generate generic content for books without specific content
        const book = booksData.find(b => b.id == bookId);
        if (book) {
            return generateGenericContent(bookId, book.title, book.author);
        }
    }
    return bookContent[bookId];
}

// Initialize reader
document.addEventListener('DOMContentLoaded', async function() {
    const urlParams = new URLSearchParams(window.location.search);
    const bookId = urlParams.get('bookId');

    if (!bookId) {
        window.location.href = 'library.html';
        return;
    }

    // Sync purchases from Firebase first
    await syncPurchasesFromFirebase();

    // Check if user has access or is in preview mode
    const previewMode = isPreviewMode(bookId);
    
    // Load book (preview or full)
    loadBook(bookId, previewMode);
    setupReaderControls();
    loadReadingPreferences();
});

function showAccessDenied() {
    document.getElementById('accessDeniedModal').style.display = 'block';
}

function loadBook(bookId, previewMode = false) {
    const book = booksData.find(b => b.id == bookId);
    if (!book) {
        window.location.href = 'library.html';
        return;
    }

    const content = getBookContent(bookId);
    if (!content) {
        window.location.href = 'library.html';
        return;
    }

    // Set book info
    document.getElementById('readerBookCover').src = book.cover;
    document.getElementById('readerBookTitle').textContent = book.title;
    document.getElementById('readerBookAuthor').textContent = `by ${book.author}`;

    // Add preview mode indicator if needed
    if (previewMode) {
        const titleElement = document.getElementById('readerBookTitle');
        const previewBadge = document.createElement('span');
        previewBadge.className = 'preview-badge';
        previewBadge.innerHTML = '<i class="fas fa-eye"></i> Preview Mode';
        previewBadge.style.cssText = `
            display: inline-block;
            background: #f39c12;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            margin-left: 10px;
            vertical-align: middle;
        `;
        titleElement.appendChild(previewBadge);
    }

    // Load chapters
    const chapterList = document.getElementById('chapterList');
    chapterList.innerHTML = '';
    content.chapters.forEach((chapter, index) => {
        const li = document.createElement('li');
        const isLocked = previewMode && index > 0; // Only first chapter is free in preview
        
        li.innerHTML = `
            <i class="fas ${isLocked ? 'fa-lock' : 'fa-book-open'}"></i> 
            ${chapter.title}
            ${isLocked ? '<span class="locked-label">üîí</span>' : ''}
        `;
        li.dataset.chapterId = chapter.id;
        
        if (isLocked) {
            li.classList.add('locked');
            li.style.opacity = '0.6';
            li.style.cursor = 'not-allowed';
        } else {
            if (index === 0) li.classList.add('active');
            li.addEventListener('click', () => loadChapter(content, chapter.id, previewMode, bookId, book));
        }
        
        chapterList.appendChild(li);
    });

    // Load first chapter
    loadChapter(content, 1, previewMode, bookId, book);

    // Store current book for navigation
    window.currentBook = { bookId, content, previewMode, book };
}

function loadChapter(bookContent, chapterId, previewMode = false, bookId = null, book = null) {
    const chapter = bookContent.chapters.find(ch => ch.id === chapterId);
    if (!chapter) return;

    const readerContent = document.getElementById('readerContent');
    
    // In preview mode, show only partial content for first chapter
    if (previewMode && chapterId === 1) {
        // Extract first few paragraphs (preview)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = chapter.content;
        const paragraphs = tempDiv.querySelectorAll('p');
        const previewParagraphs = Array.from(paragraphs).slice(0, 3); // Show first 3 paragraphs
        
        let previewContent = tempDiv.querySelector('h1') ? tempDiv.querySelector('h1').outerHTML : '';
        previewParagraphs.forEach(p => {
            previewContent += p.outerHTML;
        });
        
        // Add paywall overlay
        readerContent.innerHTML = `
            ${previewContent}
            <div class="preview-fade"></div>
            <div class="paywall-overlay">
                <div class="paywall-content">
                    <i class="fas fa-lock" style="font-size: 3rem; color: #3498db; margin-bottom: 20px;"></i>
                    <h2>Continue Reading?</h2>
                    <p>You're reading a preview of <strong>${book?.title || 'this book'}</strong></p>
                    <p>Purchase now to unlock the full book and all chapters!</p>
                    <div class="paywall-features">
                        <p><i class="fas fa-check-circle"></i> Full access to all chapters</p>
                        <p><i class="fas fa-check-circle"></i> Read anytime, anywhere</p>
                        <p><i class="fas fa-check-circle"></i> Support the author</p>
                    </div>
                    <div class="paywall-price">
                        <span class="price-label">Only</span>
                        <span class="price-amount">${book?.price || '0'} UGX</span>
                    </div>
                    <button onclick="window.location.href='order.html'" class="btn btn-primary btn-large">
                        <i class="fas fa-shopping-cart"></i> Purchase This Book
                    </button>
                    <p class="paywall-footer">
                        <a href="library.html" style="color: #7f8c8d;">‚Üê Back to Library</a>
                    </p>
                </div>
            </div>
        `;
    } else if (previewMode && chapterId > 1) {
        // Locked chapters in preview mode
        readerContent.innerHTML = `
            <div class="locked-chapter-message">
                <i class="fas fa-lock" style="font-size: 4rem; color: #e74c3c; margin-bottom: 20px;"></i>
                <h2>This Chapter is Locked</h2>
                <p>Purchase the full book to access all chapters</p>
                <button onclick="window.location.href='order.html'" class="btn btn-primary">
                    <i class="fas fa-shopping-cart"></i> Purchase Now
                </button>
            </div>
        `;
        return;
    } else {
        // Full access - show complete chapter
        readerContent.innerHTML = chapter.content;
    }

    // Update active chapter in list
    document.querySelectorAll('.chapter-list li').forEach(li => {
        li.classList.toggle('active', li.dataset.chapterId == chapterId);
    });

    // Update chapter title
    document.getElementById('currentChapter').textContent = chapter.title;

    // Update navigation buttons
    const currentIndex = bookContent.chapters.findIndex(ch => ch.id === chapterId);
    const prevBtn = document.getElementById('prevChapter');
    const nextBtn = document.getElementById('nextChapter');

    prevBtn.disabled = currentIndex === 0;
    
    // In preview mode, disable next if on first chapter
    if (previewMode) {
        nextBtn.disabled = true;
        nextBtn.title = "Purchase book to continue";
    } else {
        nextBtn.disabled = currentIndex === bookContent.chapters.length - 1;
    }

    prevBtn.onclick = () => currentIndex > 0 && loadChapter(bookContent, bookContent.chapters[currentIndex - 1].id, previewMode, bookId, book);
    nextBtn.onclick = () => {
        if (!previewMode && currentIndex < bookContent.chapters.length - 1) {
            loadChapter(bookContent, bookContent.chapters[currentIndex + 1].id, previewMode, bookId, book);
        }
    };

    // Update progress
    const progress = ((currentIndex + 1) / bookContent.chapters.length * 100).toFixed(0);
    document.getElementById('readingProgress').textContent = previewMode ? 'Preview' : `${progress}%`;

    // Scroll to top
    readerContent.scrollTop = 0;
    window.scrollTo(0, 0);

    // Save reading progress (only if full access)
    if (!previewMode && window.currentBook) {
        saveReadingProgress(window.currentBook.bookId, chapterId);
    }
}

function setupReaderControls() {
    // Get saved font size or default to 16
    const savedPrefs = JSON.parse(localStorage.getItem('readerPreferences') || '{}');
    let fontSize = savedPrefs.fontSize || 16;
    
    // Apply saved font size immediately
    updateFontSize(fontSize);
    
    // Font size controls
    const increaseBtn = document.getElementById('increaseFont');
    const decreaseBtn = document.getElementById('decreaseFont');
    
    if (increaseBtn) {
        increaseBtn.addEventListener('click', () => {
            if (fontSize < 24) {
                fontSize += 2;
                updateFontSize(fontSize);
            }
        });
    }

    if (decreaseBtn) {
        decreaseBtn.addEventListener('click', () => {
            if (fontSize > 12) {
                fontSize -= 2;
                updateFontSize(fontSize);
            }
        });
    }

    // Theme selector
    const themeSelector = document.getElementById('themeSelector');
    if (themeSelector) {
        themeSelector.addEventListener('change', (e) => {
            updateTheme(e.target.value);
        });
    }

    // Font family selector
    const fontSelector = document.getElementById('fontSelector');
    if (fontSelector) {
        fontSelector.addEventListener('change', (e) => {
            updateFontFamily(e.target.value);
        });
    }

    // Sidebar toggle
    const toggleSidebar = document.getElementById('toggleSidebar');
    if (toggleSidebar) {
        toggleSidebar.addEventListener('click', () => {
            document.querySelector('.reader-sidebar').classList.toggle('active');
        });
    }

    // Back to library
    const backBtn = document.getElementById('backToLibrary');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            window.location.href = 'library.html';
        });
    }
}

function updateFontSize(size) {
    const readerContent = document.getElementById('readerContent');
    if (readerContent) {
        readerContent.style.fontSize = `${size}px`;
        const display = document.getElementById('fontSizeDisplay');
        if (display) {
            display.textContent = `${size}px`;
        }
        savePreference('fontSize', size);
    }
}

function updateTheme(theme) {
    const content = document.getElementById('readerContent');
    if (content) {
        // Remove all theme classes
        content.classList.remove('theme-light', 'theme-sepia', 'theme-dark');
        // Add selected theme
        content.classList.add(`theme-${theme}`);
        savePreference('theme', theme);
    }
}

function updateFontFamily(font) {
    const readerContent = document.getElementById('readerContent');
    if (readerContent) {
        readerContent.style.fontFamily = font;
        savePreference('fontFamily', font);
    }
}

function savePreference(key, value) {
    const prefs = JSON.parse(localStorage.getItem('readerPreferences') || '{}');
    prefs[key] = value;
    localStorage.setItem('readerPreferences', JSON.stringify(prefs));
}

function loadReadingPreferences() {
    const prefs = JSON.parse(localStorage.getItem('readerPreferences') || '{}');
    
    if (prefs.fontSize) {
        updateFontSize(prefs.fontSize);
    } else {
        updateFontSize(16); // Default
    }
    
    if (prefs.theme) {
        const themeSelector = document.getElementById('themeSelector');
        if (themeSelector) {
            themeSelector.value = prefs.theme;
        }
        updateTheme(prefs.theme);
    } else {
        updateTheme('light'); // Default
    }
    
    if (prefs.fontFamily) {
        const fontSelector = document.getElementById('fontSelector');
        if (fontSelector) {
            fontSelector.value = prefs.fontFamily;
        }
        updateFontFamily(prefs.fontFamily);
    } else {
        updateFontFamily('Georgia, serif'); // Default
    }
}

function saveReadingProgress(bookId, chapterId) {
    const progress = JSON.parse(localStorage.getItem('readingProgress') || '{}');
    progress[bookId] = chapterId;
    localStorage.setItem('readingProgress', JSON.stringify(progress));
}
